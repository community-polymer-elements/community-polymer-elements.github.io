<dom-module id="poly-theme-api">

<template>
  <style>
    :host {
      display: none;
    }
  </style>

  <iron-ajax
      auto
      url="data.json"
      handle-as="json"
      on-response="_handleResponse"
      on-error="_handleError">
  </iron-ajax>

</template>

<script>
(function() {

  Polymer({

    is: "poly-theme-api",

    properties: {
      data: {
        type: Array,
        notify: true,
        readOnly: true
      }
    },

    _handleResponse: function(e, detail) {
      //console.log(detail.response);
      this._setData(detail.response);
    },

    _handleError: function(e, detail) {
      this._setData(null);
      console.log(detail);
    },

    generateStyle: function(elements) {
      if(elements && elements.length) {
        var props = elements.reduce(function(props, el) {
          var a = el.getActiveProperties();
          var elName = el.elementName;
          if(a && a.length) {
            a.reduce(function(props, prop) {
              props.push({ element: elName, property: prop.property.name, value: prop.value, description: prop.property.description });
              return props;
            }, props);
          }
          return props;
        }, []);

        if(props.length) {
          //save as css props file...

          var el = "";
          var lines = [];
          lines.push("<!-- Generated by Poly Theme Builder :) -->");
          lines.push("<style is=\"custom-style\">");
          lines.push("  :root {");
          var comments = true;  //need to escape comments
          for(var i = 0; i < props.length; i++) {
            var prop = props[i];
            if(prop.element !== el) {
              el = prop.element;
              lines.push("");
              if(comments) {
                lines.push("    /* " + el + " */");
              }
            }
            var line = "    " + prop.property + ": " + prop.value + ";";
            if(comments) {
              line += "  /* " + prop.description + " */";
            }
            lines.push(line);
          }
          lines.push("  }");
          lines.push("</style>");
        }

        return lines;
      }
    }

  });

})();
</script>

</dom-module>
